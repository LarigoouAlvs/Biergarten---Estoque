<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biergarten | Relat√≥rios</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
  --amarelo: #F4C430;
  --preto: #1a1a1a;
  --preto80: #262626;
}

body {
  font-family: Arial, sans-serif;
  background: var(--preto);
  color: #fff;
  margin: 0;
  padding: 20px;
}

.topo {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

h1 {
  color: var(--amarelo);
  margin: 0;
}

a.voltar {
  color: #000;
  background: var(--amarelo);
  padding: 8px 12px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: bold;
}

.acoes {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

input, button {
  padding: 10px;
  border-radius: 6px;
  border: none;
  font-weight: bold;
}

button {
  background: var(--amarelo);
  cursor: pointer;
}

.tabela {
  width: 100%;
  border-collapse: collapse;
  background: var(--preto80);
}

.tabela th, .tabela td {
  border: 1px solid #444;
  padding: 8px;
  text-align: left;
}

.tabela th {
  background: var(--amarelo);
  color: #000;
}

.entrada {
  color: #4caf50;
  font-weight: bold;
}

.saida {
  color: #ff5252;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="topo">
  <h1>üç∫ Biergarten ‚Äî Relat√≥rios</h1>
  <a href="index.html" class="voltar">‚¨Ö Voltar</a>
</div>

<div class="acoes">
  <input type="month" id="mes">
  <button id="btnPdf">üìÑ Exportar PDF</button>
</div>

<div id="lista"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyB4fG9rCJq2nUAWgu_wpCxCy8zLUvziBIA",
  authDomain: "biergarten-f5756.firebaseapp.com",
  projectId: "biergarten-f5756",
  storageBucket: "biergarten-f5756.firebasestorage.app",
  messagingSenderId: "391344176716",
  appId: "1:391344176716:web:db69d2b7d99fca2a377ee9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ELEMENTOS */
const lista = document.getElementById("lista");
const mesInput = document.getElementById("mes");
const btnPdf = document.getElementById("btnPdf");

/* ESTADO */
let dadosRelatorio = [];

/* üîé CARREGAR DADOS */
async function carregarDados() {
  lista.innerHTML = "Carregando...";

  const q = query(
    collection(db, "movimentacoes"),
    orderBy("data", "asc")
  );

  const snapshot = await getDocs(q);
  const linhas = [];

  snapshot.forEach(doc => {
    const mov = doc.data();
    const dataObj = mov.data.toDate();
    const dataFormatada = dataObj.toLocaleDateString("pt-BR");

    mov.itens.forEach(item => {
      linhas.push({
        dataObj,
        data: dataFormatada,
        colaborador: mov.colaborador || "-",
        produto: item.produto,
        entrada: mov.tipo === "entrada" ? item.quantidade : "",
        saida: mov.tipo === "saida" ? item.quantidade : ""
      });
    });
  });

  dadosRelatorio = linhas;
  aplicarFiltro();
}

/* üìÜ FILTRO POR M√äS */
function aplicarFiltro() {
  const mesSelecionado = mesInput.value;
  let filtrados = dadosRelatorio;

  if (mesSelecionado) {
    const [ano, mes] = mesSelecionado.split("-");
    filtrados = dadosRelatorio.filter(l =>
      l.dataObj.getFullYear() == ano &&
      l.dataObj.getMonth() + 1 == mes
    );
  }

  render(filtrados);
}

/* üñ•Ô∏è RENDER */
function render(linhas) {
  if (!linhas.length) {
    lista.innerHTML = "Nenhum registro encontrado.";
    return;
  }

  lista.innerHTML = `
    <table class="tabela">
      <thead>
        <tr>
          <th>Data</th>
          <th>Colaborador</th>
          <th>Produto</th>
          <th>Entrada</th>
          <th>Sa√≠da</th>
        </tr>
      </thead>
      <tbody>
        ${linhas.map(l => `
          <tr>
            <td>${l.data}</td>
            <td>${l.colaborador}</td>
            <td>${l.produto}</td>
            <td class="entrada">${l.entrada}</td>
            <td class="saida">${l.saida}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

/* üìÑ EXPORTAR PDF */
btnPdf.onclick = () => {
  if (!lista.querySelector("table")) {
    alert("Nada para exportar.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");

  doc.setFontSize(14);
  doc.text("Relat√≥rio de Movimenta√ß√µes - Biergarten", 14, 15);

  let y = 25;

  doc.setFontSize(10);
  doc.text("Data", 14, y);
  doc.text("Colaborador", 40, y);
  doc.text("Produto", 90, y);
  doc.text("Entrada", 140, y);
  doc.text("Sa√≠da", 165, y);

  y += 6;

  const linhas = lista.querySelectorAll("tbody tr");

  linhas.forEach(tr => {
    const cols = tr.querySelectorAll("td");

    if (y > 280) {
      doc.addPage();
      y = 20;
    }

    doc.text(cols[0].innerText, 14, y);
    doc.text(cols[1].innerText, 40, y);
    doc.text(cols[2].innerText, 90, y);
    doc.text(cols[3].innerText, 145, y);
    doc.text(cols[4].innerText, 170, y);

    y += 6;
  });

  doc.save("relatorio-biergarten.pdf");
};

/* EVENTOS */
mesInput.onchange = aplicarFiltro;

/* INIT */
carregarDados();
</script>

</body>
</html>
